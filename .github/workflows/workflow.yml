on:
  workflow_call:
    inputs:
      visibility:
        description: |
          `public`, `unlisted`, or `private` ([private flakes](https://docs.determinate.systems/flakehub/private-flakes) are available only on a [FlakeHub paid plan](https://flakehub.com/signup)).
        required: false
        type: string
      default-branch:
        description: |
          The [default Git branch](https://docs.github.com/repositories/configuring-branches-and-merges-in-your-repository/managing-branches-in-your-repository/changing-the-default-branch) for the repository.
        required: false
        default: ${{ github.event.repository.default_branch }}
        type: string
      enable-ssh-agent:
        description: |
          Whether to enable [`webfactory/ssh-agent`](https://github.com/webfactory/ssh-agent) in the workflow. If you set this to `true` you need to supply a secret named `ssh-private-key`.
        required: false
        default: false
        type: boolean
      directory:
        description: |
          The root directory of your flake.
        required: false
        default: "."
        type: string
      fail-fast:
        description: |
          Whether to cancel all in-progress jobs if any matrix job fails
        required: false
        default: true
        type: boolean
      flake-iter-flakeref:
        description: |
          Flake reference to use for the flake-iter process. Useful for pinning to specific versions should standards require it. Defaults to the latest release available on FlakeHub.
        type: string
        required: false
        default: https://flakehub.com/f/DeterminateSystems/flake-iter/*
      runner-map:
        description: |
          A custom mapping of [Nix system types](https://zero-to-nix.com/concepts/system-specificity) to desired Actions runners
        required: false
        type: string
        default: |
          {
            "aarch64-darwin": "macos-latest",
            "x86_64-linux": "ubuntu-latest",
            "aarch64-linux": "ubuntu-24.04-arm"
          }
      enable-lfs:
        description: |
          Whether to enable Git LFS when checking out the repository. Set to `true` if your repository uses Git LFS for large files.
        required: false
        default: false
        type: boolean
      include-output-paths:
        description: |
          Whether to include output paths when publishing to FlakeHub. Set to `false` for large/complex flakes where evaluation takes too long and causes OIDC token expiration.
        required: false
        default: true
        type: boolean
      inventory-runner:
        description: |
          The runner to use for the inventory job. Override this to use a self-hosted runner for private repos with Git LFS, since Nix's native LFS support requires authentication that GitHub-hosted runners may not have configured.
        required: false
        default: ubuntu-latest
        type: string
      use-flake-check:
        description: |
          Use `nix flake check` directly instead of flake-iter. Required for repos with Git LFS files because flake-iter locks to a git revision which causes Nix to fetch from git (LFS pointers) instead of the smudged working directory.
        required: false
        default: false
        type: boolean
    outputs:
      flake_name:
        value: ${{ jobs.success.outputs.flake_name }}
        description: |
          The name of the flake.

          Example: `DeterminateSystems/flakehub-push`
      flake_version:
        value: ${{ jobs.success.outputs.flake_version }}
        description: |
          Version of the published flake.

          Example: `0.1.99+rev-2075013a3f3544d45a96f4b35df4ed03cd53779c`
      flakeref_exact:
        value: ${{ jobs.success.outputs.flakeref_exact }}
        description: |
          A precise reference that always resolves to this to this exact release.

          Example: `DeterminateSystems/flakehub-push/=0.1.99+rev-2075013a3f3544d45a96f4b35df4ed03cd53779c`
      flakeref_at_least:
        value: ${{ jobs.success.outputs.flakeref_at_least }}
        description: |
          A loose reference to this release.
          Depending on this reference will require at least this version, and will also resolve to newer releases.
          This output is not sufficient for deployment pipelines, use flake_exact instead.

          Example: `DeterminateSystems/flakehub-push/0.1.99+rev-2075013a3f3544d45a96f4b35df4ed03cd53779c`

    secrets:
      ssh-private-key:
        required: false

jobs:
  inventory:
    runs-on: ${{ inputs.inventory-runner }}

    outputs:
      systems: ${{ steps.inventory.outputs.systems }}

    permissions:
      id-token: write
      contents: read

    steps:
      # Install git-lfs before checkout when using custom runners that may not have it
      - name: Install git-lfs (Linux)
        if: ${{ inputs.enable-lfs && runner.os == 'Linux' }}
        run: |
          if ! command -v git-lfs &> /dev/null; then
            # Download git-lfs from GitHub releases (works on Nix-based runners without sudo)
            curl -sL https://github.com/git-lfs/git-lfs/releases/download/v3.6.1/git-lfs-linux-amd64-v3.6.1.tar.gz | tar xz
            mkdir -p "$HOME/.local/bin"
            mv git-lfs-3.6.1/git-lfs "$HOME/.local/bin/"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            export PATH="$HOME/.local/bin:$PATH"
          fi
          git lfs install
      - name: Install git-lfs (macOS)
        if: ${{ inputs.enable-lfs && runner.os == 'macOS' }}
        run: |
          if ! command -v git-lfs &> /dev/null; then
            # Download git-lfs from GitHub releases (works without brew)
            curl -sL https://github.com/git-lfs/git-lfs/releases/download/v3.6.1/git-lfs-darwin-arm64-v3.6.1.zip -o git-lfs.zip
            unzip -q git-lfs.zip
            mkdir -p "$HOME/.local/bin"
            mv git-lfs-3.6.1/git-lfs "$HOME/.local/bin/"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            export PATH="$HOME/.local/bin:$PATH"
          fi
          git lfs install
      - uses: actions/checkout@v4
        with:
          lfs: ${{ inputs.enable-lfs }}
      # Configure credentials for LFS - netrc for Nix's HTTP requests
      # NOTE: Do NOT set git config --global http.extraHeader - it breaks Nix fetching public repos
      - name: Configure credentials for LFS
        if: ${{ inputs.enable-lfs }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Configure git credential helper for LFS operations
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" >> ~/.git-credentials
          # Create netrc for Nix's HTTP requests (used by determinate-nix-action)
          echo "machine github.com login x-access-token password ${GITHUB_TOKEN}" > /tmp/netrc
          chmod 600 /tmp/netrc
      # disabled pending strategy discussion on exposing tunables
      # - uses: Determinatesystems/flake-checker-action@main
      - uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            netrc-file = /tmp/netrc
      - uses: DeterminateSystems/flakehub-cache-action@main
      - uses: webfactory/ssh-agent@v0.9.0
        if: ${{ inputs.enable-ssh-agent }}
        with:
          ssh-private-key: ${{ secrets.ssh-private-key }}
      - name: Inventory the flake for targeted systems
        id: inventory
        env:
          FLAKE_ITER_RUNNER_MAP: ${{ toJson(fromJson(inputs.runner-map)) }}
          FLAKE_ITER_FLAKEREF: ${{ inputs.flake-iter-flakeref }}
        working-directory: ${{ inputs.directory }}
        run: |
          if [[ "${{ inputs.use-flake-check }}" == "true" ]]; then
            # Map runner to nix-system for single-system check
            # inventory-runner defaults to ubuntu-latest
            runner="${{ inputs.inventory-runner }}"
            case "$runner" in
              ubuntu-latest|ubuntu-22.04|ubuntu-24.04)
                nix_system="x86_64-linux"
                ;;
              macos-latest|macos-14|macos-15)
                nix_system="aarch64-darwin"
                ;;
              macos-13)
                nix_system="x86_64-darwin"
                ;;
              *)
                # Self-hosted runner - try to detect or use provided runner-map
                # For now, assume it matches the runner name pattern
                if [[ "$runner" == *"arm"* ]] || [[ "$runner" == *"aarch64"* ]]; then
                  if [[ "$runner" == *"darwin"* ]] || [[ "$runner" == *"macos"* ]]; then
                    nix_system="aarch64-darwin"
                  else
                    nix_system="aarch64-linux"
                  fi
                else
                  if [[ "$runner" == *"darwin"* ]] || [[ "$runner" == *"macos"* ]]; then
                    nix_system="x86_64-darwin"
                  else
                    nix_system="x86_64-linux"
                  fi
                fi
                ;;
            esac
            echo "systems=[{\"nix-system\":\"$nix_system\",\"runner\":\"$runner\"}]" >> "$GITHUB_OUTPUT"
          else
            nix run "$FLAKE_ITER_FLAKEREF" -- systems
          fi
  build:
    runs-on: ${{ matrix.systems.runner }}
    needs: inventory
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        systems: ${{ fromJSON(needs.inventory.outputs.systems) }}

    permissions:
      id-token: write
      contents: read

    steps:
      # Clean up stale git config from previous runs on self-hosted runners
      # A previous workflow version set http.extraHeader globally, which persists
      # and causes "Duplicate header: Authorization" errors with actions/checkout
      - name: Clean up stale git extraHeader config
        run: git config --global --unset-all http.https://github.com/.extraHeader || true
      - name: Install git-lfs (Linux)
        if: ${{ inputs.enable-lfs && runner.os == 'Linux' }}
        run: |
          if ! command -v git-lfs &> /dev/null; then
            # Download git-lfs from GitHub releases (works on Nix-based runners without sudo)
            curl -sL https://github.com/git-lfs/git-lfs/releases/download/v3.6.1/git-lfs-linux-amd64-v3.6.1.tar.gz | tar xz
            mkdir -p "$HOME/.local/bin"
            mv git-lfs-3.6.1/git-lfs "$HOME/.local/bin/"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            export PATH="$HOME/.local/bin:$PATH"
          fi
          git lfs install
      - name: Install git-lfs (macOS)
        if: ${{ inputs.enable-lfs && runner.os == 'macOS' }}
        run: |
          if ! command -v git-lfs &> /dev/null; then
            # Download git-lfs from GitHub releases (works without brew)
            curl -sL https://github.com/git-lfs/git-lfs/releases/download/v3.6.1/git-lfs-darwin-arm64-v3.6.1.zip -o git-lfs.zip
            unzip -q git-lfs.zip
            mkdir -p "$HOME/.local/bin"
            mv git-lfs-3.6.1/git-lfs "$HOME/.local/bin/"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            export PATH="$HOME/.local/bin:$PATH"
          fi
          git lfs install
      - uses: actions/checkout@v4
        with:
          lfs: ${{ inputs.enable-lfs }}
          fetch-depth: 0 # Full clone for LFS compatibility
      - name: Ensure LFS files are checked out
        if: ${{ inputs.enable-lfs }}
        run: |
          echo "Running git lfs checkout..."
          git lfs checkout
          echo "Running git lfs pull to ensure all objects are fetched..."
          git lfs pull
          # Verify LFS files are actually smudged (not pointers)
          if git lfs ls-files | head -1 | grep -q '^'; then
            echo "✅ LFS files present"
            # Check first LFS file is not a pointer (pointers are ~130 bytes)
            # Use cut instead of awk for NixOS compatibility
            first_lfs_file=$(git lfs ls-files | head -1 | cut -d' ' -f3-)
            if [ -n "$first_lfs_file" ] && [ -f "$first_lfs_file" ]; then
              file_size=$(wc -c < "$first_lfs_file")
              if [ "$file_size" -gt 200 ]; then
                echo "✅ LFS file '$first_lfs_file' is smudged (${file_size} bytes)"
              else
                echo "❌ LFS file '$first_lfs_file' appears to be a pointer (${file_size} bytes)"
                head -c 200 "$first_lfs_file"
                exit 1
              fi
            fi
          else
            echo "ℹ️ No LFS files in repository"
          fi
      # Configure credentials for LFS - netrc for Nix's HTTP requests
      # NOTE: Do NOT set git config --global http.extraHeader - it breaks Nix fetching public repos
      - name: Configure credentials for LFS
        if: ${{ inputs.enable-lfs }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Configure git credential helper for LFS operations
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" >> ~/.git-credentials
          # Create netrc for Nix's HTTP requests (used by determinate-nix-action)
          echo "machine github.com login x-access-token password ${GITHUB_TOKEN}" > /tmp/netrc
          chmod 600 /tmp/netrc
      - uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            netrc-file = /tmp/netrc
      - uses: DeterminateSystems/flakehub-cache-action@main
      - uses: webfactory/ssh-agent@v0.9.0
        if: ${{ inputs.enable-ssh-agent }}
        with:
          ssh-private-key: ${{ secrets.ssh-private-key }}
      - name: Build for ${{ matrix.systems.nix-system }}
        env:
          FLAKE_ITER_NIX_SYSTEM: ${{ matrix.systems.nix-system }}
          FLAKE_ITER_FLAKEREF: ${{ inputs.flake-iter-flakeref }}
        working-directory: ${{ inputs.directory }}
        run: |
          if [[ "${{ inputs.use-flake-check }}" == "true" ]]; then
            nix flake check --verbose
          else
            nix run "$FLAKE_ITER_FLAKEREF" -- --verbose build
          fi

  success:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ always() }}
    permissions:
      id-token: write
      contents: read

    outputs:
      flake_name: ${{ steps.publish.outputs.flake_name }}
      flake_version: ${{ steps.publish.outputs.flake_version }}
      flakeref_exact: ${{ steps.publish.outputs.flakeref_exact }}
      flakeref_at_least: ${{ steps.publish.outputs.flakeref_at_least }}
    steps:
      - run: "true"
      - run: |
          echo "A dependent in the build matrix failed."
          exit 1
        if: |
          contains(needs.*.result, 'failure') ||
          contains(needs.*.result, 'cancelled')
      - uses: actions/checkout@v4
        if: ${{ !github.repository.fork && inputs.visibility != '' && (github.ref == format('refs/heads/{0}', inputs.default-branch) || startsWith(github.ref, 'refs/tags/')) }}
        with:
          lfs: ${{ inputs.enable-lfs }}
      - uses: DeterminateSystems/determinate-nix-action@v3
        if: ${{ !github.repository.fork && inputs.visibility != '' && (github.ref == format('refs/heads/{0}', inputs.default-branch) || startsWith(github.ref, 'refs/tags/')) }}
      - uses: DeterminateSystems/flakehub-cache-action@main
        if: ${{ !github.repository.fork && inputs.visibility != '' && (github.ref == format('refs/heads/{0}', inputs.default-branch) || startsWith(github.ref, 'refs/tags/')) }}
      - uses: webfactory/ssh-agent@v0.9.0
        if: ${{ inputs.enable-ssh-agent && !github.repository.fork && inputs.visibility != '' && (github.ref == format('refs/heads/{0}', inputs.default-branch) || startsWith(github.ref, 'refs/tags/')) }}
        with:
          ssh-private-key: ${{ secrets.ssh-private-key }}
      - uses: DeterminateSystems/flakehub-push@main
        if: ${{ !github.repository.fork && inputs.visibility != '' && (github.ref == format('refs/heads/{0}', inputs.default-branch) || startsWith(github.ref, 'refs/tags/')) }}
        id: publish
        with:
          rolling: ${{ github.ref == format('refs/heads/{0}', inputs.default-branch) }}
          visibility: ${{ inputs.visibility }}
          include-output-paths: ${{ inputs.include-output-paths }}
          directory: ${{ inputs.directory }}
